<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mini Brawl</title>

<style>
html,body{
 margin:0; overflow:hidden;
 font-family:Arial;
 background:#111; color:white;
}

/* SCREENS */
.screen{
 position:fixed;
 inset:0;
 display:flex;
 flex-direction:column;
 align-items:center;
 justify-content:center;
 background:#111;
 z-index:20;
}

/* BUTTONS */
button{
 padding:14px 26px;
 margin:8px;
 font-size:18px;
 border:none;
 border-radius:14px;
 background:#ffd000;
 color:black;
}

/* HUD */
#hud{
 position:fixed;
 top:10px;
 left:10px;
 z-index:5;
}

/* JOYSTICKS */
.joy{
 position:fixed;
 width:120px;
 height:120px;
 border-radius:50%;
 background:rgba(255,255,255,0.15);
 z-index:5;
}
#moveJoy{left:20px; bottom:20px;}
#aimJoy{right:20px; bottom:20px;}

.knob{
 width:40px;
 height:40px;
 border-radius:50%;
 background:white;
 position:absolute;
 left:40px;
 top:40px;
}

/* ACTION BUTTONS */
.action{
 position:fixed;
 width:70px;
 height:70px;
 border-radius:50%;
 border:none;
 font-size:22px;
 z-index:6;
}
#gadget{right:160px; bottom:20px; background:#00ff00;}
#super{right:160px; bottom:110px; background:#ffdd00;}
</style>
</head>

<body>

<!-- LOBBY -->
<div id="lobby" class="screen">
 <h1>MINI BRAWL</h1>
 <button onclick="selectMode('brawlball')">‚öΩ Brawl Ball</button>
 <button onclick="selectMode('showdown')">‚ò†Ô∏è Showdown</button>
 <button onclick="selectMode('bounty')">‚≠ê Bounty</button>
</div>

<!-- MATCHMAKING -->
<div id="matchmaking" class="screen" style="display:none">
 <h2>Finding players‚Ä¶</h2>
 <p id="mmCount">1 / 9</p>
</div>

<!-- GAME OVER -->
<div id="gameover" class="screen" style="display:none">
 <h1 id="goText">Game Over</h1>
 <button onclick="backToLobby()">Return to Lobby</button>
</div>

<!-- HUD -->
<div id="hud" style="display:none">
 HP: <span id="hp">100</span>
 <span id="score"></span>
</div>

<!-- CONTROLS -->
<div id="controls" style="display:none">
  <div id="moveJoy" class="joy"><div class="knob"></div></div>
  <div id="aimJoy" class="joy"><div class="knob"></div></div>
  <button id="gadget" class="action">üü¢</button>
  <button id="super" class="action">üü°</button>
</div>

<!-- THREE.JS -->
<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>

<script>
/* =========================
   GLOBAL GAME STATE
========================= */
let mode=null;
let gameState="menu"; // menu | matchmaking | playing | gameover

let scene, camera, renderer;
let player;
let joyMove={x:0,y:0};
let joyAim={x:0,y:-1};

let enemies=[], bullets=[], walls=[];
let hp=100, score=0;

/* MODE DATA */
let ball=null;
let teamScore=0, enemyScore=0;
let bountyTimer=60;
let gasRadius=40;

/* =========================
   UI FLOW
========================= */
function selectMode(m){
 mode=m;
 gameState="matchmaking";
 document.getElementById("lobby").style.display="none";
 document.getElementById("matchmaking").style.display="flex";
 fakeMatchmaking();
}

function fakeMatchmaking(){
 let count=1;
 const lbl=document.getElementById("mmCount");
 const int=setInterval(()=>{
  count++;
  lbl.innerText=count+" / 9";
  if(count>=9){
   clearInterval(int);
   startGame();
  }
 },300);
}

function startGame(){
 gameState="playing";
 document.getElementById("matchmaking").style.display="none";
 document.getElementById("hud").style.display="block";
 document.getElementById("controls").style.display="block";
 initGame();
}

function endGame(text){
 gameState="gameover";
 document.getElementById("controls").style.display="none";
 document.getElementById("gameover").style.display="flex";
 document.getElementById("goText").innerText=text;
}

function backToLobby(){
 location.reload(); // safe reset
}
/* =========================
   JOYSTICK SYSTEM
========================= */
function setupJoystick(el, cb){
 const knob=el.querySelector(".knob");
 let active=false, start={x:0,y:0};

 el.addEventListener("touchstart",e=>{
  active=true;
  start.x=e.touches[0].clientX;
  start.y=e.touches[0].clientY;
 });

 el.addEventListener("touchmove",e=>{
  if(!active) return;
  const dx=e.touches[0].clientX-start.x;
  const dy=e.touches[0].clientY-start.y;
  const dist=Math.min(40,Math.hypot(dx,dy));
  const ang=Math.atan2(dy,dx);

  knob.style.left=40+Math.cos(ang)*dist+"px";
  knob.style.top =40+Math.sin(ang)*dist+"px";
  cb(Math.cos(ang)*(dist/40), Math.sin(ang)*(dist/40));
 });

 el.addEventListener("touchend",()=>{
  active=false;
  knob.style.left="40px";
  knob.style.top ="40px";
  cb(0,0);
 });
}

setupJoystick(document.getElementById("moveJoy"),(x,y)=>joyMove={x,y});
setupJoystick(document.getElementById("aimJoy"), (x,y)=>joyAim ={x,y});

/* =========================
   INIT GAME WORLD
========================= */
function initGame(){
 scene=new THREE.Scene();
 scene.background=new THREE.Color(0xe6c48f);

 camera=new THREE.PerspectiveCamera(60,innerWidth/innerHeight,0.1,200);
 camera.position.set(0,18,22);

 renderer=new THREE.WebGLRenderer({antialias:true});
 renderer.setSize(innerWidth,innerHeight);
 document.body.appendChild(renderer.domElement);

 scene.add(new THREE.AmbientLight(0xffffff,1));

 /* FLOOR */
 const floor=new THREE.Mesh(
  new THREE.PlaneGeometry(80,80),
  new THREE.MeshBasicMaterial({color:0xd2b48c})
 );
 floor.rotation.x=-Math.PI/2;
 scene.add(floor);

 /* PLAYER */
 player=new THREE.Mesh(
  new THREE.CylinderGeometry(1,1,1.6,16),
  new THREE.MeshBasicMaterial({color:0x00ffff})
 );
 player.position.y=0.8;
 scene.add(player);

 hp=100;
 document.getElementById("hp").innerText=100;

 /* CACTUSES (WALLS) */
 walls=[];
 for(let i=0;i<14;i++){
  const c=new THREE.Mesh(
   new THREE.CylinderGeometry(1.2,1.2,4,8),
   new THREE.MeshBasicMaterial({color:0x228b22})
  );
  c.position.set((Math.random()-0.5)*60,2,(Math.random()-0.5)*60);
  scene.add(c);
  walls.push(c);
 }

 /* ENEMIES (BOTS) */
 enemies=[];
 for(let i=0;i<8;i++){
  const e=new THREE.Mesh(
   new THREE.BoxGeometry(2,2,2),
   new THREE.MeshBasicMaterial({color:0xff3333})
  );
  e.position.set((Math.random()-0.5)*50,1,(Math.random()-0.5)*50);
  e.hp=60;
  e.cool=0;
  scene.add(e);
  enemies.push(e);
 }

 /* MODE SETUP */
 if(mode==="bounty"){
  score=0;
  bountyTimer=60;
  document.getElementById("score").innerText=" | Score: 0 | Time: 60";
 }
 if(mode==="showdown"){
  gasRadius=40;
 }
 if(mode==="brawlball"){
  teamScore=0;
  enemyScore=0;
 }

 loop();
}

/* =========================
   SHOOTING
========================= */
let shootCooldown=0;

function shoot(){
 if(shootCooldown>0) return;
 if(joyAim.x===0 && joyAim.y===0) return;

 shootCooldown=18;

 const b=new THREE.Mesh(
  new THREE.SphereGeometry(0.3),
  new THREE.MeshBasicMaterial({color:0xffffff})
 );
 b.position.copy(player.position);
 b.dir=new THREE.Vector3(joyAim.x,0,joyAim.y).normalize();
 scene.add(b);
 bullets.push(b);
}

/* =========================
   SUPER & GADGET
========================= */
document.getElementById("super").onclick=()=>{
 if(gameState!=="playing") return;
 player.position.x+=joyAim.x*7;
 player.position.z+=joyAim.y*7;
};

document.getElementById("gadget").onclick=()=>{
 if(gameState!=="playing") return;
 hp=Math.min(100,hp+30);
 document.getElementById("hp").innerText=Math.floor(hp);
};

/* =========================
   MAIN GAME LOOP
========================= */
function loop(){
 requestAnimationFrame(loop);
 if(gameState!=="playing") return;

 shootCooldown--;

 /* PLAYER MOVE */
 player.position.x+=joyMove.x*0.35;
 player.position.z+=joyMove.y*0.35;

 /* AUTO SHOOT */
 if(joyAim.x||joyAim.y) shoot();

 /* BULLETS */
 bullets.forEach((b,bi)=>{
  b.position.add(b.dir.clone().multiplyScalar(0.7));

  enemies.forEach((e,ei)=>{
   if(b.position.distanceTo(e.position)<1.5){
    e.hp-=20;
    scene.remove(b);
    bullets.splice(bi,1);

    if(e.hp<=0){
     scene.remove(e);
     enemies.splice(ei,1);

     if(mode==="bounty"){
      score++;
     }
    }
   }
  });
 });

 /* ENEMY AI */
 enemies.forEach(e=>{
  const dir=player.position.clone().sub(e.position).normalize();
  e.position.add(dir.multiplyScalar(0.1));

  e.cool--;
  if(e.cool<=0 && e.position.distanceTo(player.position)<10){
   hp-=2;
   e.cool=60;
  }
 });

 if(hp<=0){
  endGame("DEFEAT ‚ùå");
 }

 document.getElementById("hp").innerText=Math.floor(hp);

 /* CAMERA */
 camera.position.x+=(player.position.x-camera.position.x)*0.06;
 camera.position.z+=(player.position.z+22-camera.position.z)*0.06;
 camera.lookAt(player.position);

 renderer.render(scene,camera);
}
/* =========================
   BRAWL BALL SYSTEM
========================= */
function initBrawlBall(){
 ball=new THREE.Mesh(
  new THREE.SphereGeometry(0.6),
  new THREE.MeshBasicMaterial({color:0xffffff})
 );
 ball.position.set(0,0.6,0);
 ball.vel=new THREE.Vector3();
 scene.add(ball);

 const goalMat=new THREE.MeshBasicMaterial({color:0x0000ff});
 const goal1=new THREE.Mesh(new THREE.BoxGeometry(8,2,1),goalMat);
 const goal2=new THREE.Mesh(new THREE.BoxGeometry(8,2,1),goalMat);
 goal1.position.set(0,1,-39);
 goal2.position.set(0,1,39);
 scene.add(goal1,goal2);

 ball.goal1=goal1;
 ball.goal2=goal2;
}

/* =========================
   SHOWDOWN GAS
========================= */
function updateGas(){
 gasRadius-=0.015;

 const dist=Math.hypot(player.position.x,player.position.z);
 if(dist>gasRadius){
  hp-=0.4;
 }

 if(enemies.length===0){
  endGame("VICTORY üèÜ");
 }
}

/* =========================
   BOUNTY SYSTEM
========================= */
function updateBounty(){
 bountyTimer-=1/60;

 document.getElementById("score").innerText=
  " | Score: "+score+" | Time: "+Math.ceil(bountyTimer);

 if(bountyTimer<=0){
  if(score>=3){
   endGame("YOU WIN ‚≠ê");
  }else{
   endGame("YOU LOSE ‚ùå");
  }
 }
}

/* =========================
   MODE INIT HOOK
========================= */
/* PATCH initGame() */
const _initGame=initGame;
initGame=function(){
 _initGame();

 if(mode==="brawlball"){
  initBrawlBall();
 }
};

/* =========================
   PATCH GAME LOOP
========================= */
const _loop=loop;
loop=function(){
 requestAnimationFrame(loop);
 if(gameState!=="playing") return;

 shootCooldown--;

 /* PLAYER MOVE */
 player.position.x+=joyMove.x*0.35;
 player.position.z+=joyMove.y*0.35;

 if(joyAim.x||joyAim.y) shoot();

 /* BULLETS */
 bullets.forEach((b,bi)=>{
  b.position.add(b.dir.clone().multiplyScalar(0.7));

  enemies.forEach((e,ei)=>{
   if(b.position.distanceTo(e.position)<1.5){
    e.hp-=20;
    scene.remove(b);
    bullets.splice(bi,1);

    if(e.hp<=0){
     scene.remove(e);
     enemies.splice(ei,1);
     if(mode==="bounty") score++;
    }
   }
  });
 });

 /* ENEMIES */
 enemies.forEach(e=>{
  const dir=player.position.clone().sub(e.position).normalize();
  e.position.add(dir.multiplyScalar(0.1));

  if(e.position.distanceTo(player.position)<2){
   hp-=0.25;
  }
 });

 /* BRAWL BALL */
 if(mode==="brawlball" && ball){
  if(player.position.distanceTo(ball.position)<2){
   ball.vel.set(joyAim.x,0,joyAim.y).multiplyScalar(1.6);
  }

  ball.position.add(ball.vel);
  ball.vel.multiplyScalar(0.96);

  if(ball.position.z<-38){
   endGame("GOAL! YOU WIN ‚öΩ");
  }
  if(ball.position.z>38){
   endGame("ENEMY SCORED ‚ùå");
  }
 }

 /* SHOWDOWN */
 if(mode==="showdown"){
  updateGas();
 }

 /* BOUNTY */
 if(mode==="bounty"){
  updateBounty();
 }

 if(hp<=0){
  endGame("DEFEAT ‚ùå");
 }

 document.getElementById("hp").innerText=Math.floor(hp);

 camera.position.x+=(player.position.x-camera.position.x)*0.06;
 camera.position.z+=(player.position.z+22-camera.position.z)*0.06;
 camera.lookAt(player.position);

 renderer.render(scene,camera);
};